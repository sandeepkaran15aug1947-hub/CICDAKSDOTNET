trigger:
  branches:
    include:
      - main

variables:
  acrName: 'myacr123456r'
  resourceGroup: 'myResourceGroup'
  aksCluster: 'myAksCluster'
  imageName: 'mydotnetapp'
  azureServiceConnection: 'cicdak'

stages:
- stage: BuildAndDeploy
  displayName: Build Docker image locally and Deploy to AKS
  jobs:
  - job: BuildAndDeployJob
    displayName: Build and Deploy
    pool:
      name: 'aks'   # ðŸ‘ˆ your Windows self-hosted agent

    steps:
    - powershell: |
        Write-Output "Starting pipeline..."
      displayName: 'Start Pipeline'

    # Login to ACR
    - task: AzureCLI@2
      displayName: 'Login to ACR'
      inputs:
        azureSubscription: $(azureServiceConnection)
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          Write-Output "Logging in to ACR..."
          az acr login --name $(acrName)

    # Build & Push image locally
    - powershell: |
        Write-Output "Building Docker image locally..."
        docker build -t $(acrName).azurecr.io/$(imageName):$(Build.BuildId) .

        Write-Output "Pushing image to ACR..."
        docker push $(acrName).azurecr.io/$(imageName):$(Build.BuildId)
      displayName: 'Build and Push Docker image'

    # Deploy to AKS
    - task: AzureCLI@2
      displayName: 'Deploy to AKS'
      inputs:
        azureSubscription: $(azureServiceConnection)
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          Write-Output "Connecting to AKS..."
          az aks get-credentials --resource-group $(resourceGroup) --name $(aksCluster) --overwrite-existing

          Write-Output "Updating deployment with new image..."
          kubectl set image deployment/mydotnetapp mydotnetapp=$(acrName).azurecr.io/$(imageName):$(Build.BuildId) --record

          Write-Output "Waiting for rollout..."
         

          Write-Output "Deployment complete!"
